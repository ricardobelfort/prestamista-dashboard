<div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" (click)="onBackdropClick($event)">
  <div class="bg-white rounded-lg shadow-xl max-w-6xl w-full max-h-[90vh] overflow-hidden" (click)="$event.stopPropagation()">
    <!-- Header -->
    <div class="flex items-center justify-between p-6 border-b border-gray-200 bg-white">
      <div>
        <h2 class="text-2xl font-bold text-gray-900">Histórico Financeiro</h2>
        <p class="text-gray-600 mt-1">{{ clientName() }}</p>
      </div>
      <div class="flex items-center gap-2">
        <button 
          (click)="exportHistory()"
          class="px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 transition-colors flex items-center gap-2"
          [disabled]="loading()"
        >
          <fa-icon [icon]="faFileExcel" class="w-4 h-4"></fa-icon>
          <span>Exportar</span>
        </button>
        <button 
          (click)="close.emit()"
          class="w-10 h-10 rounded-lg hover:bg-gray-100 flex items-center justify-center transition-colors"
        >
          <fa-icon [icon]="faTimes" class="text-gray-600"></fa-icon>
        </button>
      </div>
    </div>

    <!-- Content -->
    <div class="overflow-y-auto max-h-[calc(90vh-80px)] bg-gray-50">
      @if (loading()) {
        <div class="p-8 flex items-center justify-center bg-white">
          <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
        </div>
      } @else {
        <!-- Summary Cards -->
        <div class="p-6 bg-gray-100">
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
            <!-- Total Emprestado -->
            <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm">
              <div class="flex items-center justify-between mb-2">
                <span class="text-sm text-gray-600">Total Emprestado</span>
                <fa-icon [icon]="faMoneyBill" class="text-blue-600"></fa-icon>
              </div>
              <p class="text-2xl font-bold text-gray-900">
                {{ summary().total_loaned | currency:'BRL':'symbol':'1.0-0' }}
              </p>
            </div>

            <!-- Total Pago -->
            <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm">
              <div class="flex items-center justify-between mb-2">
                <span class="text-sm text-gray-600">Total Pago</span>
                <fa-icon [icon]="faCheckCircle" class="text-emerald-600"></fa-icon>
              </div>
              <p class="text-2xl font-bold text-emerald-600">
                {{ summary().total_paid | currency:'BRL':'symbol':'1.0-0' }}
              </p>
            </div>

            <!-- Total Pendente -->
            <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm">
              <div class="flex items-center justify-between mb-2">
                <span class="text-sm text-gray-600">Pendente</span>
                <fa-icon [icon]="faClock" class="text-amber-600"></fa-icon>
              </div>
              <p class="text-2xl font-bold text-amber-600">
                {{ summary().total_outstanding | currency:'BRL':'symbol':'1.0-0' }}
              </p>
            </div>

            <!-- Score de Pagamento -->
            <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm">
              <div class="flex items-center justify-between mb-2">
                <span class="text-sm text-gray-600">Score</span>
                <fa-icon [icon]="faTrophy" [class]="getScoreColor(summary().payment_score)"></fa-icon>
              </div>
              <p class="text-2xl font-bold" [class]="getScoreColor(summary().payment_score)">
                {{ summary().payment_score | number:'1.0-0' }}/100
              </p>
            </div>
          </div>

          <!-- Payment Stats -->
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm">
              <p class="text-sm text-gray-600 mb-1">Pagamentos no Prazo</p>
              <p class="text-xl font-semibold text-emerald-600">{{ summary().on_time_payments }}</p>
            </div>
            <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm">
              <p class="text-sm text-gray-600 mb-1">Pagamentos Atrasados</p>
              <p class="text-xl font-semibold text-red-600">{{ summary().late_payments }}</p>
            </div>
            <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm">
              <p class="text-sm text-gray-600 mb-1">Total Vencido</p>
              <p class="text-xl font-semibold text-red-600">
                {{ summary().total_overdue | currency:'BRL':'symbol':'1.0-0' }}
              </p>
            </div>
          </div>
        </div>

        <!-- Loans List -->
        <div class="p-6 bg-white">
          <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
            <fa-icon [icon]="faChartLine" class="mr-2 text-blue-600"></fa-icon>
            Histórico de Empréstimos ({{ loans().length }})
          </h3>

          @if (loans().length === 0) {
            <div class="text-center py-8 bg-white rounded-lg border border-gray-200">
              <p class="text-gray-600">Nenhum empréstimo encontrado</p>
            </div>
          } @else {
            <div class="space-y-4">
              @for (loan of loans(); track loan.loan_id) {
                <div class="bg-white border border-gray-200 rounded-lg overflow-hidden shadow-sm">
                  <!-- Loan Header -->
                  <div 
                    class="p-4 cursor-pointer hover:bg-gray-50 transition-colors"
                    (click)="toggleLoan(loan.loan_id)"
                  >
                    <div class="flex items-center justify-between">
                      <div class="flex-1">
                        <div class="flex items-center gap-3 mb-2">
                          <span class="px-3 py-1 rounded-full text-xs font-semibold"
                            [class]="getLoanStatusClass(loan.status)">
                            {{ getLoanStatusLabel(loan.status) }}
                          </span>
                          <span class="text-sm text-gray-600">
                            {{ loan.start_date | date:'dd/MM/yyyy' }}
                          </span>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                          <div>
                            <p class="text-gray-600">Principal</p>
                            <p class="font-semibold text-gray-900">
                              {{ loan.principal | currency:'BRL':'symbol':'1.0-0' }}
                            </p>
                          </div>
                          <div>
                            <p class="text-gray-600">Taxa</p>
                            <p class="font-semibold text-gray-900">{{ loan.interest_rate }}% a.m.</p>
                          </div>
                          <div>
                            <p class="text-gray-600">Parcelas</p>
                            <p class="font-semibold text-gray-900">
                              {{ loan.paid_installments }}/{{ loan.total_installments }}
                            </p>
                          </div>
                          <div>
                            <p class="text-gray-600">Pago/Esperado</p>
                            <p class="font-semibold text-gray-900">
                              {{ loan.total_paid | currency:'BRL':'symbol':'1.0-0' }} / 
                              {{ loan.total_expected | currency:'BRL':'symbol':'1.0-0' }}
                            </p>
                          </div>
                        </div>
                      </div>
                      <fa-icon 
                        [icon]="expandedLoanId() === loan.loan_id ? faChevronUp : faChevronDown"
                        class="text-gray-600 ml-4"
                      ></fa-icon>
                    </div>
                  </div>

                  <!-- Installments (Expandable) -->
                  @if (expandedLoanId() === loan.loan_id) {
                    <div class="border-t border-gray-200">
                      <div class="p-4 bg-gray-50">
                        <h4 class="font-semibold text-gray-900 mb-3">Parcelas</h4>
                        <div class="space-y-2">
                          @for (inst of loan.installments; track inst.id) {
                            <div class="bg-white p-3 rounded-lg flex items-center justify-between border border-gray-200">
                              <div class="flex items-center gap-3 flex-1">
                                <fa-icon 
                                  [icon]="getInstallmentIcon(inst.status)"
                                  [class]="getInstallmentIconColor(inst.status)"
                                ></fa-icon>
                                <div>
                                  <p class="font-medium text-gray-900">
                                    Parcela {{ inst.index_no }}
                                  </p>
                                  <p class="text-xs text-gray-600">
                                    Vencimento: {{ inst.due_date | date:'dd/MM/yyyy' }}
                                    @if (inst.days_overdue > 0) {
                                      <span class="text-red-600 font-semibold">
                                        ({{ inst.days_overdue }} dias de atraso)
                                      </span>
                                    }
                                  </p>
                                </div>
                              </div>
                              <div class="text-right">
                                <p class="font-semibold text-gray-900">
                                  {{ inst.amount | currency:'BRL':'symbol':'1.2-2' }}
                                </p>
                                @if (inst.paid_amount > 0 && inst.status !== 'paid') {
                                  <p class="text-xs text-emerald-600">
                                    Pago: {{ inst.paid_amount | currency:'BRL':'symbol':'1.2-2' }}
                                  </p>
                                }
                                @if (inst.status === 'paid') {
                                  <p class="text-xs text-emerald-600 font-semibold">✓ Pago</p>
                                }
                              </div>
                            </div>
                          }
                        </div>
                      </div>
                    </div>
                  }
                </div>
              }
            </div>
          }
        </div>
      }
    </div>
  </div>
</div>
